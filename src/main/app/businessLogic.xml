<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:tracking="http://www.mulesoft.org/schema/mule/ee/tracking" xmlns:data-mapper="http://www.mulesoft.org/schema/mule/ee/data-mapper" xmlns:batch="http://www.mulesoft.org/schema/mule/batch" xmlns:sfdc="http://www.mulesoft.org/schema/mule/sfdc" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:spring="http://www.springframework.org/schema/beans" version="EE-3.5.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/batch http://www.mulesoft.org/schema/mule/batch/current/mule-batch.xsd
http://www.mulesoft.org/schema/mule/sfdc http://www.mulesoft.org/schema/mule/sfdc/current/mule-sfdc.xsd
http://www.mulesoft.org/schema/mule/ee/data-mapper http://www.mulesoft.org/schema/mule/ee/data-mapper/current/mule-data-mapper.xsd
http://www.mulesoft.org/schema/mule/ee/tracking http://www.mulesoft.org/schema/mule/ee/tracking/current/mule-tracking-ee.xsd">
    <data-mapper:config name="case_to_customobject" transformationGraphPath="case_to_customobject.grf" doc:name="case_to_customobject"/>
    <data-mapper:config name="customobject_to_case" transformationGraphPath="customobject_to_case.grf" doc:name="customobject_to_case"/>
    <batch:job name="batch">
        <batch:threading-profile poolExhaustedAction="WAIT"/>
        <batch:process-records>
            <batch:step name="getCaseInBStep" filter-expression="#['B'.equals(flowVars['sourceSystem']) || payload['ExtId__c'] == null]">
                <enricher source="#[payload]" target="#[recordVars['caseInTargetInstance']]" doc:name="store Case">
	            	<sfdc:query-single config-ref="SalesforceB" query="SELECT Id, Subject__c, LastModifiedDate FROM Case__c WHERE Id = '#[payload['ExtId__c']]'" doc:name="query Case CustomObject  from B"/>
                </enricher>
                <logger message="AAAAA  PAYLOAD #[payload]  +  RECORDVARS #[recordVars['caseInTargetInstance']" level="INFO" doc:name="Logger"/>
            
            </batch:step>
            <batch:step name="upsertCaseInBStep" filter-expression="#[('B'.equals(flowVars['sourceSystem'])) || (recordVars['caseInTargetInstance'] is NullPayload ? false : (recordVars['caseInTargetInstance'].get('LastModifiedDate') &gt;= payload.get('LastModifiedDate')) || !('${sfdc.a.integration.user.id}' == payload.get('LastModifiedById')))]">
                <expression-component doc:name="prepare case for upsert"><![CDATA[payload.remove('LastModifiedById');
payload.remove('LastModifiedDate');
payload.remove('ContactId');
//payload.remove('AccountId');
//payload.remove('Id');
]]></expression-component>
                <flow-ref name="checkTargetAccountSubflow" doc:name="check Account in instance B"/>
                <data-mapper:transform config-ref="case_to_customobject" doc:name="Case to CustomObject"/>
                <batch:commit size="100" doc:name="Batch Commit">
                    <logger message="AAAAA to upsert #[payload]" level="INFO" doc:name="Logger"/>
                    <sfdc:upsert config-ref="SalesforceB" externalIdFieldName="Id" type="Case__c" doc:name="Upsert Case CustomObject in instance B">
                        <sfdc:objects ref="#[payload]"/>
                    </sfdc:upsert>
                    <logger message="AAAAA upsert result to B #[payload]" level="INFO" doc:name="Logger"/>
                </batch:commit>

            </batch:step>
            <batch:step name="getCaseInAStep" filter-expression="#['A'.equals(flowVars['sourceSystem'])  || payload['CaseId__c'] == null]">
                <enricher source="#[payload]" target="#[recordVars['caseInTargetInstance']]" doc:name="store Case">
                    <sfdc:query-single config-ref="SalesforceA" query="SELECT Id, Subject, LastModifiedDate FROM Case WHERE Id = '#[payload['CaseId__c']]' " doc:name="query Case Object from instance A"/>
                </enricher>
                <logger message="BBBBB  RECORD #[payload]  + RECORDVARS  recordVars['caseInTargetInstance'] " level="INFO" doc:name="Logger"/>
            </batch:step>
            <batch:step name="upsertCaseInAStep" filter-expression="#[('A'.equals(flowVars['sourceSystem'])) || (recordVars['caseInTargetInstance'] is NullPayload ? false : (recordVars['caseInTargetInstance'].get('LastModifiedDate') &gt;= payload.get('LastModifiedDate')) || !('${sfdc.b.integration.user.id}' == payload.get('LastModifiedById')))]">
                <expression-component doc:name="prepare case for upsert"><![CDATA[payload.remove('LastModifiedById');
payload.remove('LastModifiedDate');
//payload.remove('ContactId');
//payload.remove('AccountId');
//payload.remove('Id');
]]></expression-component>
                <flow-ref name="checkTargetAccountSubflow" doc:name="check Account in instance B"/>
                <data-mapper:transform doc:name="Customobject To Case" config-ref="customobject_to_case"/>
                <batch:commit size="100" doc:name="Batch Commit">
                    <logger message="BBBBB to upsert #[payload]" level="INFO" doc:name="Logger"/>
                    <sfdc:upsert config-ref="SalesforceA" externalIdFieldName="Id" type="Case" doc:name="Upsert Case in instance A">
                        <sfdc:objects ref="#[payload]"/>
                    </sfdc:upsert>
                    <logger message="BBBBB upsert result to A #[payload]" level="INFO" doc:name="Logger"/>
                </batch:commit>

            </batch:step>
           
        </batch:process-records>
    </batch:job>
    <sub-flow name="checkTargetAccountSubflow" doc:name="checkTargetAccountSubflow">
        <choice doc:name="Choice">
            <when expression="#[payload.Account != null &amp;&amp; 'A'.equals(flowVars['sourceSystem'])]">
                <enricher source="#[payload]" target="#[recordVars['targetAccount']]" doc:name="storeTargetAccountForB">
                    <sfdc:query-single config-ref="SalesforceB" query="SELECT Id, Name from Account WHERE Name = '#[payload.Account.Name]'" doc:name="Query target Salesforce B for Account"/>
                </enricher>
                <choice doc:name="Choice">
                    <when expression="#[recordVars['targetAccount'] == null]">
                        <enricher source="#[payload]" target="#[recordVars['targetAccount']]" doc:name="storeTargetAccountForB">
                            <sfdc:upsert config-ref="SalesforceB" externalIdFieldName="Id" type="Account" doc:name="Insert Account in Salesforce B">
                                <sfdc:objects>
                                    <sfdc:object>
                                        <sfdc:inner-object key="Name">#[payload.Account.Name]</sfdc:inner-object>
                                    </sfdc:object>
                                </sfdc:objects>
                            </sfdc:upsert>
                        </enricher>
                        <expression-component doc:name="Expression"><![CDATA[payload.put('AccountId', recordVars['targetAccount']['Id']);]]></expression-component>
                    </when>
                    <otherwise>
                        <expression-component doc:name="Expression"><![CDATA[payload.put('AccountId', recordVars['targetAccount']['Id']);]]></expression-component>
                        <logger message="YYYYYYYY response #[payload] #[recordVars['targetAccount']]" level="INFO" doc:name="Logger"/>
                    </otherwise>
                </choice>
                <logger message="ZZZZZ new account  #[payload] #[recordVars['targetAccount']]" level="INFO" doc:name="Logger"/>
            </when>
            <when expression="#[payload.Account__r != null &amp;&amp; 'B'.equals(flowVars['sourceSystem'])]">
                <enricher source="#[payload]" target="#[recordVars['targetAccount']]" doc:name="storeTargetAccountForA">
                    <sfdc:query-single config-ref="SalesforceA" query="SELECT Id, Name from Account WHERE Name = '#[payload.Account__r.Name]'" doc:name="Query target Salesforce A for Account"/>
                </enricher>
                <logger message="XXXXXXX response #[payload] #[recordVars['targetAccount']]" level="INFO" doc:name="LoggerXXXX"/>
                <expression-component doc:name="Expression"><![CDATA[payload.put('AccountId', recordVars['targetAccount']['Id']);]]></expression-component>
            </when>
            <otherwise>
                <logger message="ZZZZZZ do nothing" level="INFO" doc:name="Do nothing"/>
            </otherwise>
        </choice>
    </sub-flow>
</mule>
